<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>会议转写小助手</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="css/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
    <div class="app-container">
        <!-- 顶部导航栏 -->
        <header class="header">
            <h1><i class="fas fa-microphone-alt"></i> 会议转写小助手</h1>
            <div class="mode-switcher">
                <button class="active" id="interview-mode">
                    <i class="fas fa-comments"></i> 采访稿模式
                </button>
                <button id="speech-outline-mode">
                    <i class="fas fa-list"></i> 演讲提纲模式
                </button>
                <button id="speech-mode">
                    <i class="fas fa-microphone"></i> 演讲稿模式
                </button>
            </div>
        </header>

        <!-- 主要内容区 -->
        <main class="main-content">
            <!-- 输入区域 -->
            <section class="input-section">
                <div class="upload-area" id="dropZone">
                    <i class="fas fa-file-upload"></i>
                    <p>拖拽文本文件到此处或点击上传</p>
                    <p class="file-types">支持 Markdown、Word、TXT 等格式</p>
                    <input type="file" id="fileInput" accept=".md,.txt,.doc,.docx" hidden>
                </div>

                <!-- 智能粘贴板 -->
                <div class="clipboard-area">
                    <h3><i class="fas fa-clipboard"></i> 智能粘贴板</h3>
                    <textarea id="originalTextArea" placeholder="粘贴带时间戳的文本..."></textarea>
                </div>
            </section>

            <!-- 处理控制台 -->
            <section class="control-panel">
                <div class="processing-options">
                    <label class="toggle">
                        <input type="checkbox" checked>
                        <span class="slider">术语标准化</span>
                    </label>
                    <label class="toggle">
                        <input type="checkbox" checked>
                        <span class="slider">情感保留</span>
                    </label>
                    <label class="toggle">
                        <input type="checkbox" checked>
                        <span class="slider">智能分段</span>
                    </label>
                </div>
                <button class="process-btn" id="processBtn">
                    <i class="fas fa-magic"></i> 开始处理
                </button>
            </section>

            <!-- 输出区域 -->
            <section class="output-section">
                <div class="output-header">
                    <h3><i class="fas fa-file-alt"></i> 原始文本</h3>
                    <h3><i class="fas fa-file-word"></i> 处理结果</h3>
                </div>
                <div class="output-container">
                    <div class="original-text" id="displayOriginalText">
                        <div class="content">
                            <p>请在上方粘贴需要处理的文本...</p>
                        </div>
                    </div>
                    <div class="processed-text" id="processedText">
                        <div class="content">
                            <p>处理后的结果将显示在这里...</p>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <!-- 底部工具栏 -->
        <footer class="footer">
            <button class="export-btn">
                <i class="fas fa-cloud-download-alt"></i> 云端保存
            </button>
            <button class="export-btn">
                <i class="fas fa-download"></i> 本地导出
            </button>
            <div class="contact-info">会议记录整理助手@2025，如有任何优化需求联系 Qiri Zhang 19946286616（微信同号）</div>
        </footer>
    </div>
    <script>
        // 当前模式
        let currentMode = 'interview';

        // 模式切换
        document.getElementById('interview-mode').addEventListener('click', function() {
            setActiveMode(this, 'interview');
        });
        
        document.getElementById('speech-outline-mode').addEventListener('click', function() {
            setActiveMode(this, 'speech-outline');
        });
        
        document.getElementById('speech-mode').addEventListener('click', function() {
            setActiveMode(this, 'speech');
        });

        function setActiveMode(button, mode) {
            document.querySelectorAll('.mode-switcher button').forEach(btn => {
                btn.classList.remove('active');
            });
            button.classList.add('active');
            currentMode = mode;
        }

        // 初始化上传区域
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const originalTextArea = document.getElementById('originalTextArea');
        const displayOriginalText = document.getElementById('displayOriginalText');
        const processedText = document.getElementById('processedText');
        const processBtn = document.getElementById('processBtn');

        // 上传区域点击触发文件选择
        dropZone.addEventListener('click', () => {
            fileInput.click();
        });

        // 文件拖拽
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.style.borderColor = 'var(--primary-color)';
            dropZone.style.background = 'var(--primary-color-light)';
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.style.borderColor = 'var(--primary-color-light)';
            dropZone.style.background = 'transparent';
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.style.borderColor = 'var(--primary-color-light)';
            dropZone.style.background = 'transparent';
            
            const file = e.dataTransfer.files[0];
            if (file) {
                readFile(file);
            }
        });

        // 文件选择
        fileInput.addEventListener('change', () => {
            const file = fileInput.files[0];
            if (file) {
                readFile(file);
            }
        });

        // 读取文件内容
        function readFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const content = e.target.result;
                originalTextArea.value = content;
                updateOriginalTextDisplay();
            };
            reader.readAsText(file);
        }

        // 自动更新原始文本显示
        originalTextArea.addEventListener('input', updateOriginalTextDisplay);
        
        // 粘贴事件处理
        originalTextArea.addEventListener('paste', function() {
            setTimeout(updateOriginalTextDisplay, 0);
        });

        function updateOriginalTextDisplay() {
            const text = originalTextArea.value;
            if (text) {
                displayOriginalText.innerHTML = `<div class="content">${formatText(text)}</div>`;
            } else {
                displayOriginalText.innerHTML = `<div class="content"><p>请在上方粘贴需要处理的文本...</p></div>`;
            }
        }

        // 格式化文本，将时间戳和发言人标记出来
        function formatText(text) {
            // 简单的格式化，实际应用可能需要更复杂的正则处理
            return text.replace(/\n/g, '<br>')
                       .replace(/(\[\d+:\d+\])/g, '<span class="timestamp">$1</span>')
                       .replace(/【([^】]+)】/g, '<span class="speaker">【$1】</span>');
        }

        // 处理按钮点击事件
        processBtn.addEventListener('click', async () => {
            const text = originalTextArea.value;
            
            if (!text) {
                processedText.innerHTML = '<div class="error">请先输入或粘贴需要处理的文本</div>';
                return;
            }
            
            // 禁用按钮，显示加载状态
            processBtn.disabled = true;
            processBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 处理中...';
            processedText.innerHTML = '<div class="loading">正在处理文本，目前调用DeepSeek-R1预计处理需要3-5分钟，请稍候...</div>';

            try {
                console.log('Sending request with:', { text, mode: currentMode });
                
                // 调用 Cloudflare Worker API 提交处理请求
                const response = await fetch('https://meeting-assistant-worker.qiriz.workers.dev/process', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ text, mode: currentMode })
                });
                
                const result = await response.json();
                
                if (result.success && result.requestId) {
                    // 接收到请求ID，开始轮询状态
                    const requestId = result.requestId;
                    processedText.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> 大模型正在处理文本中，预计需要3-5分钟...</div>';
                    
                    // 轮询数据
                    pollForResults(requestId);
                } else {
                    processedText.innerHTML = `<div class="error">处理失败: ${result.error || '未知错误'}</div>`;
                    // 恢复按钮状态
                    processBtn.disabled = false;
                    processBtn.innerHTML = '<i class="fas fa-magic"></i> 开始处理';
                }
            } catch (error) {
                console.error('Error:', error);
                processedText.innerHTML = `<div class="error">处理请求出错: ${error.message}</div>`;
                // 恢复按钮状态
                processBtn.disabled = false;
                processBtn.innerHTML = '<i class="fas fa-magic"></i> 开始处理';
            }
        });
        
        // 轮询结果函数
        async function pollForResults(requestId) {
            try {
                // 轮询间隔（秒）
                const pollInterval = 5000; // 5秒轮询一次
                let dots = 0;
                
                // 创建轮询
                const checkStatus = async () => {
                    try {
                        // 更新加载标识
                        dots = (dots + 1) % 4;
                        const dotString = '.'.repeat(dots);
                        const timeElapsed = Math.floor((Date.now() - startTime) / 1000);
                        const timeDisplay = `[已等待 ${Math.floor(timeElapsed / 60)}:${(timeElapsed % 60).toString().padStart(2, '0')}]`;
                        
                        processedText.querySelector('.loading').innerHTML = 
                            `<i class="fas fa-spinner fa-spin"></i> 大模型正在处理文本中${dotString} ${timeDisplay}`;
                        
                        // 发送状态查询请求
                        const statusResponse = await fetch(`https://meeting-assistant-worker.qiriz.workers.dev/status?requestId=${requestId}`);
                        const statusResult = await statusResponse.json();
                        
                        if (statusResult.success) {
                            if (statusResult.completed) {
                                // 处理完成
                                clearInterval(pollTimer);
                                
                                if (statusResult.processed_text) {
                                    // 成功获取处理结果
                                    processedText.innerHTML = `<div class="content">${marked.parse(statusResult.processed_text)}</div>`;
                                } else if (statusResult.error) {
                                    // 处理出错
                                    processedText.innerHTML = `<div class="error">处理失败: ${statusResult.error}</div>`;
                                }
                                
                                // 恢复按钮状态
                                processBtn.disabled = false;
                                processBtn.innerHTML = '<i class="fas fa-magic"></i> 开始处理';
                            }
                            // 如果未完成，继续轮询
                        } else {
                            // 查询状态出错
                            clearInterval(pollTimer);
                            processedText.innerHTML = `<div class="error">查询状态失败: ${statusResult.error || '未知错误'}</div>`;
                            
                            // 恢复按钮状态
                            processBtn.disabled = false;
                            processBtn.innerHTML = '<i class="fas fa-magic"></i> 开始处理';
                        }
                    } catch (error) {
                        console.error('Polling error:', error);
                    }
                };
                
                // 记录开始时间
                const startTime = Date.now();
                
                // 立即检查一次
                await checkStatus();
                
                // 开始定时轮询
                const pollTimer = setInterval(checkStatus, pollInterval);
                
                // 设置超时保护，10分钟后停止轮询
                setTimeout(() => {
                    clearInterval(pollTimer);
                    // 如果还在加载中，显示超时消息
                    if (processBtn.disabled) {
                        processedText.innerHTML = '<div class="error">请求超时，请尝试减少文本量或稍后再试</div>';
                        processBtn.disabled = false;
                        processBtn.innerHTML = '<i class="fas fa-magic"></i> 开始处理';
                    }
                }, 10 * 60 * 1000); // 10分钟
                
            } catch (error) {
                console.error('Polling setup error:', error);
                processedText.innerHTML = `<div class="error">轮询状态出错: ${error.message}</div>`;
                // 恢复按钮状态
                processBtn.disabled = false;
                processBtn.innerHTML = '<i class="fas fa-magic"></i> 开始处理';
            }
        }

        // 在页面加载时初始化
        function init() {
            // 清空输入和输出
            originalTextArea.value = '';
            displayOriginalText.innerHTML = `<div class="content"><p>请在上方粘贴需要处理的文本...</p></div>`;
            processedText.innerHTML = `<div class="content"><p>处理后的结果将显示在这里...</p></div>`;
        }

        // 初始化
        init();
    </script>
</body>
</html>
